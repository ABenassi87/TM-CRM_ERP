{"tabs":[{"id":"1498552695920","name":"Prices","icon":"fa-object-ungroup","linker":"prices","index":0},{"name":"Orders","linker":"orders","id":"1498565673952","index":1}],"components":[{"component":"redissubscribe","state":{"text":"","color":"gray"},"x":18,"y":172,"tab":"1498552695920","connections":{"0":["1498565569369"]},"id":"1498562933261","options":{"channel":"product:*"},"name":"product","reference":"update"},{"component":"debug","state":{"text":"Disabled","color":"gray"},"x":261,"y":662,"tab":"1498552695920","connections":{},"id":"1498563181178","options":{"enabled":false,"property":""},"name":""},{"component":"switch","state":{"text":"","color":"gray"},"x":320,"y":154,"tab":"1498552695920","connections":{"0":["1498573052034"],"1":["1498563854903"]},"id":"1498563752381","options":{"conditions":[{"operator":"==","datatype":"String","value":"product:updateDirectCost","index":0},{"operator":"==","datatype":"String","value":"product:update","index":1}],"property":"channel"},"name":"product:*","reference":"","output":2},{"component":"debug","state":{"text":"Disabled","color":"gray"},"x":879,"y":276,"tab":"1498552695920","connections":{},"id":"1498563854903","options":{"enabled":false},"name":"Debug"},{"component":"condition","state":{"text":"","color":"gray"},"x":190,"y":163,"tab":"1498552695920","connections":{"0":["1498563752381"]},"id":"1498565569369","options":{"output":1,"condition":"// Next has to contain an index for output (null/undefiend) will cancel current data\n\nnext(value.data.product && value.data.product._id ? 0 : null)"},"name":"isProduct","output":1,"reference":""},{"component":"functiontm","state":{"text":"","color":"gray"},"x":577,"y":57,"tab":"1498552695920","connections":{},"id":"1498573052034","options":{"code":"function(data, callback) {\n    var ProductModel = MODEL('product').Schema;\n    \n    ProductModel.find({ 'bundles.id': data.product._id })\n                        //.populate({ path: 'product', select: 'sellFamily', populate: { path: \"sellFamily\" } })\n                        //.populate(\"priceLists\")\n                        .populate(\"pack.id\", \"info directCost indirectCost\")\n                        .populate(\"bundles.id\", \"info directCost indirectCost\")\n                        .populate({\n                            path: 'info.productType'\n                                //    populate: { path: \"options\" }\n                        })\n                        .populate({\n                            path: 'sellFamily',\n                            populate: { path: \"options\", populate: { path: \"group\" } }\n                        })\n                        .exec(function(err, products) {\n                            products.forEach(function(product) {\n                                if (!product.isBundle)\n                                    return;\n\n                                product.save(function(err, doc) {\n                                    if (err)\n                                        return callback(err);\n\n                                    //F.functions.PubSub.emit('product:updateDirectCost', {\n                                    //    data: doc\n                                    //});\n                                });\n                            });\n        \tcallback(null,{data:\"Ca marche !\", output:0});\n                        });\n   \n\tconsole.log(\"toto\", data);\n};","output":1,"outputs":1},"name":"Test"},{"component":"redissubscribe","state":{"text":"","color":"gray"},"x":18,"y":438,"tab":"1498552695920","connections":{"0":["1498662090959"]},"id":"1498662045118","options":{"channel":"productFamily:*"},"name":"productFamily","reference":"update"},{"component":"switch","state":{"text":"Last: productFamily:update","color":"gray"},"x":237,"y":426,"tab":"1498552695920","connections":{"0":["1498721905919"],"1":["1498724762730"]},"id":"1498662090959","options":{"conditions":[{"operator":"==","datatype":"String","value":"productFamily:update","index":0},{"operator":"==","datatype":"String","value":"productFamily:coefUpdate","index":1}],"property":"channel"},"name":"productFamily:*","output":2},{"component":"functiontm","state":{"text":"","color":"gray"},"x":528,"y":158,"tab":"1498552695920","connections":{},"id":"1498663475268","options":{"code":"function(data, callback) {\n    \n\tcallback(null,{data : data, output:0});\n};","output":1,"outputs":1},"name":"Change indirectCostRate"},{"component":"functiontm","state":{"text":"","color":"gray"},"x":598,"y":342,"tab":"1498552695920","connections":{},"id":"1498664643692","options":{"code":"function(family, instance, callback) {\n    var ProductModel = MODEL('product').Schema;\n    var round = MODULE('utils').round;\n    var async = require('async');\n    \n    instance.debug(\"Update products with this family\",\"info\");\n        \n    ProductModel.find({ sellFamily: family._id }, function(err, docs) {\n       \tasync.each(docs, function(elem, aCb) {\n       \t\telem.indirectCost = round(elem.directCost * family.indirectCostRate / 100, 3);\n           \telem.save(aCb);\n       \t}, function(err){\n       \t\tif (err)\n           \t\treturn callback(\"update productFamily error \", err);\n           \tcallback(null, 0, family);\n      \t});\n    });\n};","output":1,"outputs":1},"name":"UpdateIndirectCostRate","reference":""},{"component":"function","state":{"text":"","color":"gray"},"x":442,"y":342,"tab":"1498552695920","connections":{},"id":"1498721905919","options":{"code":"var object = flowdata.data.data;\n\nif(!object.family || !object.family._id)\n    return;\n\nif(!object.family.indirectCostRate)\n \treturn;\n\nsend(object.family);","outputs":1},"name":""},{"component":"function","state":{"text":"","color":"gray"},"x":438,"y":535,"tab":"1498552695920","connections":{"0":["1498735846662"]},"id":"1498724762730","options":{"code":"var object = flowdata.data.data;\n\nif(!object.family || !object.family._id)\n    return;\n\nif(!object.productFamilyCoef || !object.productFamilyCoef._id)\n    return;\n\nsend(object);","outputs":1},"name":""},{"component":"functiontm","state":{"text":"","color":"gray"},"x":605,"y":542,"tab":"1498552695920","connections":{"0":["1498739891221"]},"id":"1498735846662","options":{"output":2,"code":"function(data, instance, callback) {\n    var ProductModel = MODEL('product').Schema;\n    var round = MODULE('utils').round;\n    var async = require('async');\n    \n    instance.debug(\"Update products with this family\",\"info\");\n        \n    ProductModel.find({ sellFamily: data.family._id }, function(err, docs) {\n        if(err || !docs)\n            return instance.debug(err);\n        \n       \tasync.each(docs, function(elem, aCb) {\n            console.log(elem);\n            instance.send(1,{product:elem});\n            aCb();\n       \t}, function(err){\n       \t\tif (err)\n           \t\treturn callback(\"update productFamily error \", err);\n           \tcallback(null, 0, data.family);\n      \t});\n    });\n};","outputs":1},"name":"UpdateFamilyCoef","output":2},{"component":"redispublish","state":{"text":"","color":"gray"},"x":918,"y":622,"tab":"1498552695920","connections":{},"id":"1498737059143","options":{"channel":"product:updateDirectCost"},"name":"product:updateDirectCost"},{"component":"debug","state":{"text":"Enabled","color":"gray"},"x":968,"y":513,"tab":"1498552695920","connections":{},"id":"1498739891221","options":{"enabled":true}}]}