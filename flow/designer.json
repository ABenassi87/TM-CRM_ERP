{"tabs":[{"id":"1498552695920","name":"Products / Prices","icon":"fa-object-ungroup","linker":"products-prices","index":0},{"name":"Orders","linker":"orders","id":"1498565673952","index":1},{"name":"Delivery","linker":"delivery","id":"1499065218412","index":2}],"components":[{"component":"redissubscribe","state":{"text":"","color":"gray"},"x":18,"y":172,"tab":"1498552695920","connections":{"0":["1498565569369"]},"id":"1498562933261","options":{"channel":"product:*"},"name":"product","reference":"update","errors":{}},{"component":"debug","state":{"text":"Disabled","color":"gray"},"x":879,"y":276,"tab":"1498552695920","connections":{},"id":"1498563854903","options":{"enabled":false},"name":"Debug","errors":{}},{"component":"condition","state":{"text":"","color":"gray"},"x":273,"y":152,"tab":"1498552695920","connections":{},"id":"1498565569369","options":{"output":1,"condition":"// Next has to contain an index for output (null/undefiend) will cancel current data\n\nif(value.product && value.product._id)\n    return next();\n\nnext(0)"},"name":"isProduct","output":1,"reference":"","errors":{}},{"component":"functiontm","state":{"text":"","color":"gray"},"x":577,"y":57,"tab":"1498552695920","connections":{},"id":"1498573052034","options":{"code":"function(data, callback) {\n    var ProductModel = MODEL('product').Schema;\n    \n    ProductModel.find({ 'bundles.id': data.product._id })\n                        //.populate({ path: 'product', select: 'sellFamily', populate: { path: \"sellFamily\" } })\n                        //.populate(\"priceLists\")\n                        .populate(\"pack.id\", \"info directCost indirectCost\")\n                        .populate(\"bundles.id\", \"info directCost indirectCost\")\n                        .populate({\n                            path: 'info.productType'\n                                //    populate: { path: \"options\" }\n                        })\n                        .populate({\n                            path: 'sellFamily',\n                            populate: { path: \"options\", populate: { path: \"group\" } }\n                        })\n                        .exec(function(err, products) {\n                            products.forEach(function(product) {\n                                if (!product.isBundle)\n                                    return;\n\n                                product.save(function(err, doc) {\n                                    if (err)\n                                        return callback(err);\n\n                                    //F.functions.PubSub.emit('product:updateDirectCost', {\n                                    //    data: doc\n                                    //});\n                                });\n                            });\n        \tcallback(null,{data:\"Ca marche !\", output:0});\n                        });\n   \n\tconsole.log(\"toto\", data);\n};","output":1,"outputs":1},"name":"Test","errors":{}},{"component":"functiontm","state":{"text":"","color":"gray"},"x":435,"y":340,"tab":"1498552695920","connections":{"0":["1498739891221"]},"id":"1498664643692","options":{"code":"function(data, instance, callback) {\n    var family = data.family;\n    var ProductModel = MODEL('product').Schema;\n    var round = MODULE('utils').round;\n    var async = require('async');\n    \n    instance.debug(\"Update products with this family\",\"info\");\n        \n    ProductModel.find({ sellFamily: family._id }, function(err, docs) {\n       \tasync.each(docs, function(elem, aCb) {\n       \t\telem.indirectCost = round(elem.directCost * family.indirectCostRate / 100, 3);\n           \telem.editedBy = data.userId;\n            elem.save(aCb);\n       \t}, function(err){\n       \t\tif (err)\n           \t\treturn callback(\"update productFamily error \", err);\n           \tcallback(null, 0, data);\n      \t});\n    });\n};","output":1,"outputs":1},"name":"UpdateIndirectCostRate","reference":"","output":1,"errors":{}},{"component":"functiontm","state":{"text":"","color":"gray"},"x":470,"y":645,"tab":"1498552695920","connections":{"1":["1498739891221"]},"id":"1498735846662","options":{"code":"function(data, instance, callback) {\n    var ProductModel = MODEL('product').Schema;\n    var round = MODULE('utils').round;\n    var async = require('async');\n    \n    instance.debug(\"Update products with this family\",\"info\");\n        \n    ProductModel.find({ sellFamily: data.family._id }, function(err, docs) {\n        if(err || !docs)\n            return instance.debug(err);\n        \n       \tasync.each(docs, function(elem, aCb) {\n            console.log(elem);\n            instance.send(1,{product:elem, userId : data.userId});\n            aCb();\n       \t}, function(err){\n       \t\tif (err)\n           \t\treturn callback(\"update productFamily error \", err);\n           \tcallback(null, 0, data);\n      \t});\n    });\n};","output":2,"outputs":1},"name":"UpdateFamilyCoef","output":2,"errors":{}},{"component":"redispublish","state":{"text":"","color":"gray"},"x":918,"y":622,"tab":"1498552695920","connections":{},"id":"1498737059143","options":{"channel":"product:updateDirectCost"},"name":"product:updateDirectCost","errors":{}},{"component":"debug","state":{"text":"Enabled","color":"gray"},"x":793,"y":491,"tab":"1498552695920","connections":{},"id":"1498739891221","options":{"enabled":true},"name":"Debug","errors":{}},{"component":"redismq","state":{"text":"","color":"gray"},"x":16,"y":662,"tab":"1498552695920","connections":{"0":["1498770223136"]},"id":"1498767289354","options":{"channel":"productFamily:coefUpdate"},"name":"coefUpdate","errors":{}},{"component":"condition","state":{"text":"","color":"gray"},"x":287,"y":560,"tab":"1498552695920","connections":{"0":["1498735846662"]},"id":"1498770223136","options":{"condition":"// Next has to contain an index for output (null/undefiend) will cancel current data\n\nif(!value.family || !value.family._id)\n    return next();\n\nif(!value.productFamilyCoef || !value.productFamilyCoef._id)\n    return next();\n\nnext(0);","output":1},"output":1,"name":"IsFamilyCoef","errors":{}},{"component":"condition","state":{"text":"","color":"gray"},"x":286,"y":467,"tab":"1498552695920","connections":{"0":["1498664643692"]},"id":"1498770944578","options":{"condition":"// Next has to contain an index for output (null/undefiend) will cancel current data\n\nif(!value.family || !value.family._id)\n    return next();\n\nif(!value.family.indirectCostRate)\n \treturn next();\n\nnext(0);","output":1},"name":"IsFamilyCost","output":1,"errors":{}},{"component":"redismq","state":{"text":"","color":"gray"},"x":21,"y":343,"tab":"1498552695920","connections":{"0":["1498770944578"]},"id":"1498771042591","options":{"channel":"productFamily:update"},"name":"update","reference":"productFamily","errors":{}},{"component":"redispop","state":{"text":"","color":"gray"},"x":17,"y":658,"tab":"1498552695920","connections":{"0":["1498770223136"]},"id":"1498771893593","options":{"method":"PubSub","channel":"productFamily:coefUpdate"},"name":"coefUpdate","reference":"productFamily","errors":{}},{"component":"redispop","state":{"text":"","color":"gray"},"x":20,"y":327,"tab":"1498552695920","connections":{"0":["1498770944578"]},"id":"1498771971248","options":{"method":"PubSub","channel":"productFamily:update"},"name":"update","reference":"productFamily","errors":{}},{"component":"redispop","state":{"text":"","color":"gray"},"x":29,"y":175,"tab":"1498552695920","connections":{"0":["1498565569369"]},"id":"1498772142216","options":{"method":"PubSub","channel":"product:update"},"name":"update","reference":"product","errors":{}},{"component":"dssi","state":{"text":"Connected","color":"green"},"x":21,"y":36,"tab":"1499065218412","connections":{},"id":"1499068439358","options":{"qos":1,"port":"1883","hostname":"symeos.net","id":"45b9c68e-eb38-4630-a6f0-55dc714eaa1c","token":"ad8409775a0403c8e35e72e80e0fe2b603277d2b","uuid":"45b9c68e-eb38-4630-a6f0-55dc714eaa1c"},"name":"MQTT DSSI broker","errors":{}},{"component":"dssisubscribe","state":{"text":"Connected","color":"green"},"x":15,"y":254,"tab":"1499065218412","connections":{"0":["1499083298589"]},"id":"1499068670490","options":{"broker":"45b9c68e-eb38-4630-a6f0-55dc714eaa1c","topic":"39c66926-bdab-41b6-9630-c65a2794f681","uuid":"39c66926-bdab-41b6-9630-c65a2794f681"},"name":"Messages","errors":{}},{"component":"debug","state":{"text":"Enabled","color":"gray"},"x":836,"y":387,"tab":"1499065218412","connections":{},"id":"1499068678037","options":{"enabled":true},"errors":{}},{"component":"functiontm","state":{"text":"","color":"gray"},"x":511,"y":130,"tab":"1499065218412","connections":{"0":["1499085844043"],"2":["1499087793960"]},"id":"1499081609730","options":{"code":"function(data, instance, callback) {\n    var DeliveryModel = MODEL('order').Schema.GoodsOutNote;\n    \n    instance.send(1, data);\n    \n    DeliveryModel.findOne({ ref : new RegExp(data.ref+\"$\", \"gi\") }, function(err, doc) {\n        \t\n       \t\tif (err || !doc)\n           \t\treturn callback(\"update Delivery error \" + err);\n        \n        \tdoc.editedBy = data.data.data.userId;\n        \tdoc.status.isPicked = new Date();\n        \tdoc.status.pickedBy = data.data.data.userId;\n        \n        \tdoc.save(function(err, doc){\n                if (err || !doc)\n           \t\t\treturn callback(\"update Delivery error \" + err);\n                \n                //Info alert user\n           \t\tinstance.send(0, {\n                    userId: [data.data.data.userId],\n                    data : {\n                    \ttitle : \"Mise a jour BL\",\n                    \tmessage : {\n                        \tbody : \"BL \" + doc.ref + \"mis a jour\",\n                        \tdelay : 3000\n                        }\n                    }\n                });\n                \n                //Go to page Angular\n                instance.send(2, {\n                    userId: [data.data.data.userId],\n                    data : {\n                    \troute : 'order',\n                        go : 'delivery.show',\n                    \t_id : doc._id.toString(),\n                    \tmessage : \"Mise a jour externe du BL\",\n                    }\n                });\n            });\n      \t});\n    });\n};","output":3},"name":"AddPicking","output":3,"errors":{}},{"component":"function","state":{"text":"","color":"gray"},"x":209,"y":142,"tab":"1499065218412","connections":{"0":["1499084355238"]},"id":"1499083298589","options":{"code":"var barcode = flowdata.data;\n//var type = barcode.substr(0,1);\n\nif(!barcode.data || !barcode.data.barcode)\n    return;\n\nbarcode = barcode.data.barcode;\nvar type = barcode.substr(0,1);\n\nvar obj = {\n\ttype : type\n};\n\n\nsend({\n    type : type,\n    ref : barcode.substr(4,6) + \"/\" + parseInt(barcode.substr(10,2)),\n    data:value.flowdata.data\n});","outputs":1},"name":"decode","reference":"BarCode","errors":{}},{"component":"switch","state":{"text":"","color":"gray"},"x":391,"y":245,"tab":"1499065218412","connections":{"0":["1499081609730"]},"id":"1499084355238","options":{"conditions":[{"operator":"==","datatype":"Number","value":"4","index":0},{"operator":"==","datatype":"Number","value":"5","index":1}],"property":"type"},"name":"Type","output":2,"errors":{}},{"component":"redispush","state":{"text":"","color":"gray"},"x":776,"y":70,"tab":"1499065218412","connections":{},"id":"1499085844043","options":{"method":"PubSub","channel":"notify:user"},"name":"NotifyUser"},{"component":"redispush","state":{"text":"","color":"gray"},"x":786,"y":230,"tab":"1499065218412","connections":{},"id":"1499087793960","options":{"method":"PubSub","channel":"notify:controllerAngular"},"name":"NotifyAngular"}]}