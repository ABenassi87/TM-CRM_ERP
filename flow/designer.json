{"tabs":[{"id":"1498552695920","name":"Products / Prices","icon":"fa-object-ungroup","linker":"products-prices","index":0},{"name":"Orders","linker":"orders","id":"1498565673952","index":1}],"components":[{"component":"redissubscribe","state":{"text":"","color":"gray"},"x":18,"y":172,"tab":"1498552695920","connections":{"0":["1498565569369"]},"id":"1498562933261","options":{"channel":"product:*"},"name":"product","reference":"update"},{"component":"debug","state":{"text":"Disabled","color":"gray"},"x":879,"y":276,"tab":"1498552695920","connections":{},"id":"1498563854903","options":{"enabled":false},"name":"Debug"},{"component":"condition","state":{"text":"","color":"gray"},"x":218,"y":113,"tab":"1498552695920","connections":{},"id":"1498565569369","options":{"condition":"// Next has to contain an index for output (null/undefiend) will cancel current data\n\nif(value.product && value.product._id)\n    return next();\n\nnext(0)","output":1},"name":"isProduct","output":1,"reference":""},{"component":"functiontm","state":{"text":"","color":"gray"},"x":577,"y":57,"tab":"1498552695920","connections":{},"id":"1498573052034","options":{"code":"function(data, callback) {\n    var ProductModel = MODEL('product').Schema;\n    \n    ProductModel.find({ 'bundles.id': data.product._id })\n                        //.populate({ path: 'product', select: 'sellFamily', populate: { path: \"sellFamily\" } })\n                        //.populate(\"priceLists\")\n                        .populate(\"pack.id\", \"info directCost indirectCost\")\n                        .populate(\"bundles.id\", \"info directCost indirectCost\")\n                        .populate({\n                            path: 'info.productType'\n                                //    populate: { path: \"options\" }\n                        })\n                        .populate({\n                            path: 'sellFamily',\n                            populate: { path: \"options\", populate: { path: \"group\" } }\n                        })\n                        .exec(function(err, products) {\n                            products.forEach(function(product) {\n                                if (!product.isBundle)\n                                    return;\n\n                                product.save(function(err, doc) {\n                                    if (err)\n                                        return callback(err);\n\n                                    //F.functions.PubSub.emit('product:updateDirectCost', {\n                                    //    data: doc\n                                    //});\n                                });\n                            });\n        \tcallback(null,{data:\"Ca marche !\", output:0});\n                        });\n   \n\tconsole.log(\"toto\", data);\n};","output":1,"outputs":1},"name":"Test"},{"component":"functiontm","state":{"text":"","color":"gray"},"x":435,"y":340,"tab":"1498552695920","connections":{"0":["1498739891221"]},"id":"1498664643692","options":{"code":"function(data, instance, callback) {\n    var family = data.family;\n    var ProductModel = MODEL('product').Schema;\n    var round = MODULE('utils').round;\n    var async = require('async');\n    \n    instance.debug(\"Update products with this family\",\"info\");\n        \n    ProductModel.find({ sellFamily: family._id }, function(err, docs) {\n       \tasync.each(docs, function(elem, aCb) {\n       \t\telem.indirectCost = round(elem.directCost * family.indirectCostRate / 100, 3);\n           \telem.editedBy = data.userId;\n            elem.save(aCb);\n       \t}, function(err){\n       \t\tif (err)\n           \t\treturn callback(\"update productFamily error \", err);\n           \tcallback(null, 0, data);\n      \t});\n    });\n};","output":1,"outputs":1},"name":"UpdateIndirectCostRate","reference":"","output":1},{"component":"functiontm","state":{"text":"","color":"gray"},"x":473,"y":648,"tab":"1498552695920","connections":{"1":["1498739891221"]},"id":"1498735846662","options":{"output":2,"code":"function(data, instance, callback) {\n    var ProductModel = MODEL('product').Schema;\n    var round = MODULE('utils').round;\n    var async = require('async');\n    \n    instance.debug(\"Update products with this family\",\"info\");\n        \n    ProductModel.find({ sellFamily: data.family._id }, function(err, docs) {\n        if(err || !docs)\n            return instance.debug(err);\n        \n       \tasync.each(docs, function(elem, aCb) {\n            console.log(elem);\n            instance.send(1,{product:elem, userId : data.userId});\n            aCb();\n       \t}, function(err){\n       \t\tif (err)\n           \t\treturn callback(\"update productFamily error \", err);\n           \tcallback(null, 0, data);\n      \t});\n    });\n};","outputs":1},"name":"UpdateFamilyCoef","output":2},{"component":"redispublish","state":{"text":"","color":"gray"},"x":918,"y":622,"tab":"1498552695920","connections":{},"id":"1498737059143","options":{"channel":"product:updateDirectCost"},"name":"product:updateDirectCost"},{"component":"debug","state":{"text":"Enabled","color":"gray"},"x":968,"y":513,"tab":"1498552695920","connections":{},"id":"1498739891221","options":{"enabled":true},"name":"Debug"},{"component":"redismq","state":{"text":"","color":"gray"},"x":16,"y":662,"tab":"1498552695920","connections":{"0":["1498770223136"]},"id":"1498767289354","options":{"channel":"productFamily:coefUpdate"},"name":"coefUpdate"},{"component":"condition","state":{"text":"","color":"gray"},"x":300,"y":561,"tab":"1498552695920","connections":{"0":["1498735846662"]},"id":"1498770223136","options":{"condition":"// Next has to contain an index for output (null/undefiend) will cancel current data\n\nif(!value.family || !value.family._id)\n    return next();\n\nif(!value.productFamilyCoef || !value.productFamilyCoef._id)\n    return next();\n\nnext(0);","output":1},"output":1,"name":""},{"component":"condition","state":{"text":"","color":"gray"},"x":299,"y":465,"tab":"1498552695920","connections":{"0":["1498664643692"]},"id":"1498770944578","options":{"output":1,"condition":"// Next has to contain an index for output (null/undefiend) will cancel current data\n\nif(!value.family || !value.family._id)\n    return next();\n\nif(!value.family.indirectCostRate)\n \treturn next();\n\nnext(0);"},"name":"Condition","output":1},{"component":"redismq","state":{"text":"","color":"gray"},"x":21,"y":343,"tab":"1498552695920","connections":{"0":["1498770944578"]},"id":"1498771042591","options":{"channel":"productFamily:update"},"name":"update","reference":"productFamily"},{"component":"redispop","state":{"text":"","color":"gray"},"x":17,"y":658,"tab":"1498552695920","connections":{"0":["1498770223136"]},"id":"1498771893593","options":{"channel":"productFamily:coefUpdate"},"name":"coefUpdate","reference":"productFamily"},{"component":"redispop","state":{"text":"","color":"gray"},"x":6,"y":327,"tab":"1498552695920","connections":{"0":["1498770944578"]},"id":"1498771971248","options":{"channel":"productFamily:update"},"name":"update","reference":"productFamily"},{"component":"redispop","state":{"text":"","color":"gray"},"x":6,"y":124,"tab":"1498552695920","connections":{"0":["1498565569369"]},"id":"1498772142216","options":{"channel":"product:update"},"name":"update","reference":"product"}]}