<div ng-init="findOne()">
    <script type="text/ng-template" id="searchproduct.html">
        <a ng-class="{'list-group-item bg-green bg-font-green': match.model.priceLists.defaultPriceList == true}">
            <span bind-html-unsafe="match.model.ref | typeaheadHighlight:query"></span> - <span bind-html-unsafe="match.model.info.langs[0].name"></span> ({{match.model.priceLists.priceListCode}} : {{match.model.prices.price|currency}})
        </a>
    </script>
    <!--<script type="text/ng-template" id="searchcompany.html">
        <a>
            <span ng-bind-html="match.model.code_client | typeaheadHighlight:query"></span> - <span ng-bind-html="match.model.name"></span>
        </a>
    </script>-->


    <div class="page-bar">
        <ul class="page-breadcrumb">
            <li>
                <i class="fa fa-home"></i>
                <a ui-sref="home">@(Home)</a>
                <i class="fa fa-angle-right"></i>
            </li>
            <li>
                <a ui-sref="offer.list">@(propal:CommercialProposals)</a>
                <i class="fa fa-angle-right"></i>
            </li>
            <li>
                <span>{{offer.ref}}</span>
            </li>
        </ul>
        <div class="page-toolbar">
            <div class="btn-group pull-right">
                <button type="button" class="btn yellow-crusta dropdown-toggle uppercase" data-toggle="dropdown" data-hover="dropdown" data-delay="1000" data-close-others="true">
                   <i class="fa fa-share"></i> @(Tools) <i class="fa fa-angle-down"></i>
                </button>
                <ul class="dropdown-menu pull-right" role="menu">
                    <li>
                        <a ng-show="offer.Status == 'VALIDATED'" ng-hide="!global.user.rights.offer.createOrder" ng-confirm-click="@(propal:ConfirmClosePropal)" ng-confirm-title="@(propal:PropalStatusSigned)" confirmed-click="createOrder()">
                            <i class="fa fa-shopping-cart"></i> @(propal:CreateOrder)
                        </a>
                    </li>
                    <li>
                        <a href="#" ng-show="offer.Status == 'DRAFT'" ng-hide="!global.user.rights.offer.validate" data-ng-click="changeStatus('VALIDATED')">
                            <i class="fa fa-thumbs-o-up"></i> @(Validate)
                        </a>
                    </li>
                    <li>
                        <a href="#" ng-show="offer.Status !== 'DRAFT' && login.rights.offer.create" data-ng-click="changeStatus('DRAFT')">
                            <i class="fa fa-history"></i> @(ReOpen)
                        </a>
                    </li>
                    <li>
                        <a ng-show="offer.Status == 'VALIDATED'" ng-hide="!global.user.rights.offer.createDelivery" ng-confirm-click="@(propal:ConfirmClosePropal)" ng-confirm-title="@(propal:PropalStatusNotSigned)" confirmed-click="changeStatus('NOTSIGNED')">
                            <i class="fa fa-thumbs-o-down"></i> @(propal:CloseOfferOrder)
                        </a>
                    </li>
                    <li>
                        <a href="#" data-ng-click="clone()">
                            <i class="fa fa-copy"></i> @(ToClone)
                        </a>
                    </li>
                    <li>
                        <a ng-show='offer.Status != "DRAFT"' ng-href="/erp/api/offer/pdf/{{offer.ref}}" target="_blank">
                            <i class="fa fa-file-pdf-o"></i> @(BuildPDF)
                        </a>
                    </li>
                    <li>
                        <a ng-show='offer.Status != "DRAFT" && offer.contacts.length' ng-href="#" ng-click="sendEmail()">
                            <i class="fa  fa-envelope"></i> @(mails:SendMail)
                        </a>
                    </li>
                    <li>
                        <a href="#" class="font-red" ng-show="login.rights.offer.delete && offer.Status !== 'SIGNED'" confirmed-click="remove(offer)" ng-confirm-click="Supprimer la proposition commerciale ?" title="Supprimer la proposition commerciale">
                            <i class="fa fa-trash-o font-red"></i> @(Delete)
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <!-- <h3 class="page-title">
        <i class="fa fa-calculator"></i> @(propal:CommercialProposal) {{offer.ref}} {{offer.client.name}}<small> @(From) {{offer.createdAt| date:'@(main:date.format.java.dayhour)'}}</small>
    </h3>
    -->


    <div class="row">
        <div class="col-md-12">
            <div class="form-horizontal form-row-seperated">
                <div class="portlet light portlet-fit bordered">
                    <div class="portlet-title">
                        <div class="caption">
                            <i class="icon-info"></i>
                            <span class="caption-subject dark bold uppercase">@(propal:CommercialProposals) - {{offer.ref}} - {{offer.supplier.fullName}} </span>
                        </div>
                        <div ng-include="'/templates/saveMenu.html'" class="actions btn-set"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-7 col-sm-12">
            <div class="portlet light mt-element-ribbon portlet-fit bordered ">
                <div class="ribbon ribbon-right ribbon-clip ribbon-shadow ribbon-border-dash-hor uppercase" ng-class="offer.status.css">
                    <div class="ribbon-sub ribbon-clip ribbon-right"></div> {{offer.status.name}} </div>
                <div class="portlet-title">
                    <div class="caption">
                        <i class="fa fa-cogs"></i>
                        <span class="caption-subject uppercase"> @(propal:Details)</span>
                    </div>
                </div>
                <div class="portlet-body">
                    <div class="row">
                        <div class="col-md-6 col-sm-12">

                            <crm-id label="@(companies:Customer)" name="societeId" ng-model="offer.supplier" entity="offer.entity" url="/erp/api/societe/autocomplete" required="true" on-select="updateAddress" placeholder="@(companies:CompanyName)" class="form-group form-md-line-input"></crm-id>

                            <div class="form-group form-md-line-input ">
                                <input type="text" class="form-control" id="ref_client" ng-model="offer.ref_client">
                                <label for="ref_client">@(orders:RefCustomerOrder)</label>
                            </div>

                            <div class="row">
                                <div class="col-md-6 col-sm-12">
                                    <div class="form-group form-md-line-input">
                                        <input type="text" class="form-control" id="entity" disabled ng-model="offer.entity">
                                        <label for="entity">@(Entity)</label>
                                    </div>
                                </div>
                                <div class="col-md-6 col-sm-12">
                                    <div class="form-group form-md-line-input">
                                        <div class="form-control form-control-static"> {{offer.ref}} </div>
                                        <label for="form_control_1">@(Ref) @(propal:CommercialProposal)</label>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 col-sm-12">
                                    <div class="form-group form-md-line-input">
                                        <div class="form-control form-control-static"> {{offer.supplier.salesPurchases.priceList.priceListCode}} </div>
                                        <label for="price_level">@(products:PriceLevel)</label>
                                    </div>
                                </div>
                                <div class="col-md-6 col-sm-12">
                                    <div class="form-group form-md-line-input">
                                        <div class="form-control form-control-static"> {{offer.total_ht| currency}} @(HT) </div>
                                        <label for="form_control_1">@(Amounts) @(propal:CommercialProposal)</label>
                                    </div>
                                </div>
                            </div>
                            <hr>
                            <div class="form-group form-md-line-input">
                                <div class="form-control form-control-static"> {{history.date| date:'dd/MM/yyyy HH:mm'}} {{history.msg}}</div>
                                <label for="form_control_1">@(Logs)</label>
                            </div>

                            <div class="row">
                                <!-- <div class="col-md-6 col-sm-12">
                                    <div class="form-group form-md-line-input">
                                        <select class="form-control" id="Status" ng-model="offer.Status" ng-options="s.id as s.label for s in dict.fk_offer_status.values">
                                                </select>
                                        <label for="Status">@(Status)</label>
                                    </div>
                                </div>
                                <div class="col-md-6 col-sm-12">
                                    <div class="form-group form-md-line-input">
                                        <div class="form-control form-control-static"> {{offer.updatedAt|date:'dd/MM/yyyy HH:mm'}} </div>
                                        <label for="form_control_1">@(DateLastModification)</label>
                                    </div>
                                </div>-->
                            </div>
                        </div>

                        <div class="col-md-6 col-sm-12">

                            <div class="form-group form-md-line-input">
                                <select class="form-control" id="type" ng-model="offer.type" ng-options="s.id as s.label for s in dict.fk_input_reason.values">
                                       </select>
                                <label for="type">@(orders:OrderMode)</label>
                            </div>
                            <div class="form-group form-md-line-input">
                                <select class="form-control" id="delivery_mode" ng-model="offer.delivery_mode" ng-options="s as s for s in delivery_mode">
                                        </select>
                                <label for="delivery_mode">@(orders:RemovingOrder)</label>
                            </div>
                            <div class="form-group form-md-line-input">
                                <input type="text" class="form-control" id="dateLivraison" date-input ng-model="offer.date_livraison">
                                <label for="dateLivraison">@(DeliveryDate)</label>
                            </div>
                            <div class="form-group form-md-line-input">
                                <select class="form-control" id="cond_reglement_code" ng-model="offer.cond_reglement_code" ng-options="s.id as s.label for s in dict.fk_payment_term.values">
                                        </select>
                                <label for="cond_reglement_code">@(deliveries:PaymentConditions)</label>
                            </div>
                            <div class="form-group form-md-line-input">
                                <select class="form-control" id="mode_reglement_code" ng-model="offer.mode_reglement_code" ng-options="s.id as s.label for s in dict.fk_paiement.values">
                                        </select>
                                <label for="mode_reglement_code">@(bills:PaymentMode)</label>
                            </div>

                            <div class="form-group form-md-line-input">
                                <select class="form-control" id="commercial_id" ng-model="offer.salesPerson" ng-options="s._id as s.fullName for s in $dict.employees">
                                </select>
                                <label for="commercial_id">@(commercial:Commercial)</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-5 col-sm-12">
            <div class="portlet light">
                <div class="portlet-title">
                    <div class="caption">
                        <i class="fa fa-money"></i>
                        <span class="caption-subject uppercase"> @(bills:BillAddress)</span>
                    </div>
                    <div class="tools">
                        <a href="" class="collapse" data-original-title="" title=""> </a>
                    </div>
                </div>
                <div class="portlet-body" style="display: block;">
                    <div class="form-group form-md-line-input ">
                        <address ng-model=offer.address></address>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-5 col-sm-12">
            <div class="portlet light">
                <div class="portlet-title">
                    <div class="caption">
                        <i class="fa fa-truck"></i>
                        <span class="caption-subject uppercase"> @(deliveries:DeliveryAddress)</span>
                    </div>
                    <div class="tools">
                        <a href="" class="expand" data-original-title="" title=""> </a>
                    </div>
                </div>
                <div class="portlet-body" style="display: none;">
                    <div class="form-group form-md-line-input ">
                        <address ng-model=offer.shippingAddress></address>
                    </div>
                </div>
            </div>
        </div>

        <!--<div class="col-md-5 col-sm-12">
                <div class="portlet light">
                    <div class="portlet-title">
                        <div class="caption">
                            <i class="fa fa-user"></i>
                            <span class="caption-subject uppercase"> @(Contacts)</span>
                        </div>
                        <div class="tools">
                            <a href="" class="expand" data-original-title="" title=""> </a>
                        </div>
                    </div>
                    <div class="portlet-body" style="display: none;">
                        <form editable-form name="contactForm" onaftersave="update()">
                            <div class="portlet light">
                                <div class="portlet-title">
                                    <div class="caption font-yellow-crusta">
                                        <i class="fa fa-group font-yellow-crusta"></i> @(Contacts)
                                    </div>
                                </div>
                                <div class="portlet-body" crm-contact model="bill.contacts" societe="bill.client"></div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>-->
    </div>
</div>






<div class="row">
    <div class="col-md-12 col-sm-12">
        <div class="portlet portlet light bordered">
            <div class="portlet-title">
                <div class="caption">
                    <i class="fa fa-opencart"></i>
                    <span class="caption-subject dark bold uppercase"> @(ShoppingCard)</span>
                </div>
                <div class="actions">
                    <a href="javascript:;" ng-click="tableform.$show();
                                            settings.layout.pageSidebarClosed = true;" ng-show="!tableform.$visible && editable" class="btn yellow-crusta">
                        <i class="fa fa-pencil"></i> @(Edit) </a>
                </div>
                <div class="actions">
                    <div class="btn-form" ng-show="tableform.$visible">

                        <button type="button" ng-disabled="tableform.$waiting" ng-click="addLine(offer.lines)" class="btn blue"> @(Add) <i class="fa fa-plus"></i></button>
                    </div>
                </div>
            </div>
            <div class="portlet-body">
                <form editable-form name="tableform" onaftersave="update();settings.layout.pageSidebarClosed = false;" oncancel="findOne();settings.layout.pageSidebarClosed = false;">
                    <!-- table -->
                    <table class="table table-fixed table-striped table-bordered table-hover no-footer">
                        <thead>
                            <tr role="row" class="heading">
                                <th style="width: 140px;">@(products:ProductCode)</th>
                                <th style="width: 15%;">@(Name)</th>
                                <th style="width: 25%;">@(Description)</th>
                                <th>@(Qty)</th>
                                <th style="width: 120px;">@(AmountHT)</th>
                                <th>@(Discount)%</th>
                                <th>@(Taxes)</th>
                                <th>@(TotalHT)</th>
                                <th style="width: 140px;"><span ng-show="tableform.$visible">Action</span></th>
                            </tr>
                        </thead>
                        <tr ng-repeat="line in offer.lines| filter:filterLine" ng-class="{success:line.type == 'SUBTOTAL',bold:line.type == 'SUBTOTAL'}">
                            <td ng-if="line.type != 'SUBTOTAL'">
                                <div class="input-icon right">
                                    <i class="fa fa-warning font-red pull-right" ng-show="!line.product._id" title="@(products:ErrorProductBadRefOrLabel)"></i>
                                    <span ng-class="{'has-error':$error, 'has-success': !$error}" editable-text="line.product.info.SKU" e-typeahead="product as product.ref for product in productAutoComplete($viewValue, 'ref')" e-typeahead-template-url="searchproduct.html" e-typeahead-on-select="addProduct($item, line.idLine, offer.lines)"
                                        onbeforesave="checkLine(line.product)">
                                                            {{ line.product.info.SKU || 'empty' }}
                                                        </span>
                                </div>
                            </td>
                            <td ng-if="line.type != 'SUBTOTAL'">
                                <!--<span editable-text="line.info.langs[0].name" e-form="tableform">-->
                                {{ line.product.info.langs[0].name || 'empty' }}
                                <!--</span>-->
                            </td>
                            <td ng-if="line.type != 'SUBTOTAL'">
                                <!-- editable username (text with validation) -->
                                <span editable-textarea="line.description" e-rows="4" e-cols="50" e-form="tableform">
                                                        <pre class="no-padding small">{{ line.description || 'empty' }}</pre>
                                                    </span>
                            </td>
                            <td ng-if="line.type != 'SUBTOTAL'" class="align-right">
                                <span e-name="qty" editable-number="line.qty" e-ng-change="calculMontantHT(line, $data, 'qty')" e-min="0" e-step="0.001" e-form="tableform">
                                                        {{ line.qty || 0 }} <small>{{line.product.unit}}</small>
                                                    </span>
                            </td>
                            <td ng-if="line.type != 'SUBTOTAL'" class="align-right">
                                <div class="checkbox-list" ng-show="tableform.$visible">
                                    <label>
                                                            <input type="checkbox" ng-change="calculMontantHT(line, $data)" ng-model="line.priceSpecific" ng-checked="line.priceSpecific"> Mod. </label>
                                </div>
                                <a href="#" tooltip="Tarif specific" ng-show="line.priceSpecific && !tableform.$visible"><i class="fa fa-warning font-yellow-gold"></i></a>
                                <input type="number" ng-show="tableform.$visible" ng-disabled="!line.priceSpecific" class="form-control" ng-model="line.pu_ht" min="0" step="0.001" ng-change="calculMontantHT(line, $data)">
                                <span ng-show="!tableform.$visible">{{ line.pu_ht || 0 | number:3}}</span>
                                <!--<span editable-number="line.pu_ht" e-ng-disabled="!line.priceSpecific" e-ng-change="calculMontantHT(line, $data, 'pu_ht')" e-min="0" e-step="0.001" e-form="tableform">
                                                        {{ line.pu_ht || 0 | number:3}}
                                                    </span>-->
                            </td>
                            <td ng-if="line.type != 'SUBTOTAL'" class="align-right">
                                <input type="number" ng-show="tableform.$visible" ng-disabled="!line.priceSpecific" class="form-control" ng-model="line.discount" min="0" step="0.01" ng-change="calculMontantHT(line, $data)">
                                <span ng-show="!tableform.$visible">{{ line.discount || 0 | percent:3}}</span>
                                <!--<span editable-number="line.discount" e-ng-change="calculMontantHT(line, $data, 'discount')" e-min="0" e-step="0.001" e-form="tableform">
                                                        {{ line.discount || 0 | percent:3}}
                                                    </span>-->
                            </td>
                            <td ng-if="line.type != 'SUBTOTAL'" class="align-right">
                                <span editable-select="line.total_taxes[0].taxeId" e-ng-change="calculMontantHT(line, $data, 'tva_tx')" e-form="tableform" e-ng-options="s._id as s.name for s in taxes | filter : {isFixValue:false}">
                                        <span ng-repeat="taxe in line.product.taxes">
                                            <span ng-if="line.product.taxes[$index].taxeId.rate">{{ line.total_taxes[$index].value | currency}} ({{line.product.taxes[$index].taxeId.rate | percent:1}})</span>
                                <span ng-if="line.product.taxes[$index].taxeId.isFixValue">{{ line.total_taxes[$index].value | currency}} ({{line.product.taxes[$index].taxeId.code}})</span>
                                </span>
                                </span>
                            </td>
                            <td ng-if="line.type != 'SUBTOTAL'" class="align-right">
                                <span ng-model="montantHT[$index]" form="tableform">
                                                        {{ line.total_ht | number:2 }}
                                                    </span>
                            </td>

                            <td ng-if="line.type == 'SUBTOTAL'" colspan="7">
                                Sous-total
                            </td>
                            <td ng-if="line.type == 'SUBTOTAL'">
                                {{ line.total_ht | number:2 }}
                            </td>
                            <td>
                                <div class="btn-toolbar" role="toolbar">
                                    <div class="btn-group btn-group" ng-if="line.type != 'SUBTOTAL'">
                                        <button type="button" ng-show="!tableform.$visible && editable" ng-disabled="$index == 0" ng-click="upDownLine($index, 'UP', offer.lines)" class="btn btn-default btn-icon-only btn-sm fa fa-angle-up" title="@(Up)"></button>
                                        <button type="button" ng-show="!tableform.$visible && editable" ng-disabled="$index == (offer.lines.length - 1)" ng-click="upDownLine($index, 'DOWN', offer.lines)" class="btn btn-default btn-icon-only btn-sm fa fa-angle-down" title="@(Down)"></button>
                                    </div>
                                    <div class="btn-group btn-group">

                                        <button type="button" ng-show="tableform.$visible && line.product.dynForm" ng-click="editLine(line, line.idLine, offer.lines)" class="btn btn-default btn-icon-only btn-sm fa fa-pencil" title="@(Edit)"></button>
                                        <button type="button" ng-show="tableform.$visible  && line.type != 'SUBTOTAL'" ng-click="copyLine(line, offer.lines)" class="btn btn-default btn-icon-only btn-sm fa fa-copy" title="@(TocLone)"></button>
                                        <button type="button" ng-show="tableform.$visible && line.type != 'SUBTOTAL'" ng-click="AddSubTotal($index)" class="btn btn-default btn-icon-only btn-sm fa fa-bars" title="@(AddSubtotal)"></button>
                                        <button type="button" ng-show="tableform.$visible" ng-click="deleteLine(line)" class="btn red btn-default btn-icon-only btn-sm fa fa-trash-o" title="@(Delete)"></button>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    </table>
                    <!-- buttons -->

                    <div class="btn-form" ng-show="tableform.$visible">

                        <button type="button" ng-disabled="tableform.$waiting" ng-click="addLine(offer.lines)" class="btn blue "><i class="fa fa-plus"></i> @(AddNewLine)</button>


                        <button type="submit" ng-disabled="tableform.$waiting" class="btn green pull-right"> @(Save) <i class="fa fa-check"></i></button>
                        <button type="button" ng-disabled="tableform.$waiting" ng-click="tableform.$cancel()" class="btn red pull-right"><i class="fa fa-angle-left"></i> @(Cancel) </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>


<div class="row">
    <div class="col-md-7 col-sm-12">
        <crm-notes ng-model="offer.notes[0]" ng-change="update()"></crm-notes>
    </div>

    <div class="col-md-5 col-sm-12">
        <div class="portlet light portlet bordered">
            <div class="portlet-title">
                <div class="caption">
                    <i class="icon-plane font-grey-gallery"></i>
                    <span class="caption-subject bold font-grey-gallery uppercase"> @(deliveries:ShippingCost) </span>
                </div>
            </div>
            <div class="portlet-body">
                <div class="row static-info align-reverse">
                    <div class="col-md-5 name">@(TotalWeight) : </div>
                    <div class="col-md-7 value">{{offer.weight| number : 2}} kg</div>
                </div>
                <div class="row static-info align-reverse">
                    <div class="col-md-5 name">@(AmountHT) : <span class="icon-pencil grey" ng-click="shipping.$show()" ng-hide="shipping.$visible || !editable"></span></div>
                    <div class="col-md-7 value"><span editable-text="offer.shipping.total_ht" e-style="width: 80px" blur="submit" buttons="no" onaftersave="update()" e-form="shipping">
                                            {{offer.shipping.total_ht| currency}}
                                        </span></div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-offset-7 col-md-5 col-sm-12">
        <div class="portlet mt-element-ribbon light portlet-fit bordered">
            <div class="ribbon ribbon-vertical-right ribbon-shadow ribbon-color-warning uppercase">
                <div class="ribbon-sub ribbon-bookmark"></div>
                <i class="fa fa-pause"></i>
            </div>
            <div class="portlet-title">
                <div class="caption">
                    <i class=" icon-control-pause font-yellow-crusta"></i>
                    <span class="caption-subject font-yellow-crusta bold uppercase">@(Totaux)</span>
                </div>
            </div>
            <div class="portlet-body">
                <div class="row static-info align-reverse">
                    <div class="col-md-5 name">@(AmountHT) :</div>
                    <div class="col-md-7 value">{{offer.total_ht| currency}}</div>
                </div>
                <div class="row static-info align-reverse">
                    <div class="col-md-5 name">@(AmountTaxes) :</div>
                    <div class="col-md-7 value">
                        <div class="row static-info align-reverse" ng-repeat="vat in offer.total_taxes">
                            <div class="col-md-6 name">{{vat.taxeId.langs[0].label}}</div>
                            <div class="col-md-6 value">{{vat.value| currency}}</div>
                        </div>
                    </div>
                </div>
                <div class="row static-info align-reverse">
                    <div class="col-md-5 name bold">@(AmountTTC) :</div>
                    <div class="col-md-7 value bold">{{offer.total_ttc| currency}}</div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>